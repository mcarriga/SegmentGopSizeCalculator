<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Segment GOP Size Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ Video Segment GOP Size Calculator</h1>
        
        <div class="params">
            <div class="param-item">
                <div class="param-label">Video Frame Rate</div>
                <select id="frameRateSelect" onchange="onFrameRateChange()">
                    <option value="15">15 fps</option>
                    <option value="24000/1001">23.976 fps (24000/1001)</option>
                    <option value="24">24 fps</option>
                    <option value="25">25 fps (PAL)</option>
                    <option value="30000/1001" selected>29.97 fps (30000/1001) - NTSC</option>
                    <option value="30">30 fps</option>
                    <option value="48">48 fps</option>
                    <option value="50">50 fps</option>
                    <option value="60000/1001">59.94 fps (60000/1001)</option>
                    <option value="60">60 fps</option>
                    <option value="120">120 fps</option>
                </select>
            </div>
            <div class="param-item">
                <div class="param-label">Audio Sample Rate</div>
                <select id="audioSampleRateSelect" onchange="onAudioParameterChange()">
                    <option value="8000">8,000 Hz</option>
                    <option value="12000">12,000 Hz</option>
                    <option value="16000">16,000 Hz</option>
                    <option value="22050">22,050 Hz</option>
                    <option value="24000">24,000 Hz</option>
                    <option value="32000">32,000 Hz</option>
                    <option value="44100">44,100 Hz</option>
                    <option value="48000" selected>48,000 Hz</option>
                    <option value="88200">88,200 Hz</option>
                    <option value="96000">96,000 Hz</option>
                </select>
            </div>
            <div class="param-item">
                <div class="param-label">Audio Frames/Packet</div>
                <select id="audioFramesPerPacketSelect" onchange="onAudioParameterChange()">
                    <option value="960">960 frames</option>
                    <option value="1024" selected>1,024 frames</option>
                </select>
            </div>
            <div class="param-item">
                <div class="param-label">Audio Packet Duration</div>
                <div class="param-value" id="audioPacketDuration">21.33 ms</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="calculateGOPSizes()">Calculate First 20 Valid GOP Sizes</button>
        </div>

        <div class="results">
            <h3 style="margin-top: 0; color: #4a5568;">Valid GOP Sizes (frames)</h3>
            <div class="results-grid" id="resultsGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #a0aec0;">
                    Click "Calculate" to generate GOP sizes
                </div>
            </div>
        </div>

        <div class="explanation">
            <h3 style="margin-top: 0; color: #2d3748;">ðŸ“š How it works:</h3>
            <p>This calculator finds GOP sizes where video frames align perfectly with audio packet boundaries to avoid audio/video sync issues.</p>
            
            <div class="formula">
Audio packet duration = Audio Frames Ã· Sample Rate<br/>
Video frame duration = 1 Ã· Frame Rate<br/>

GOP duration = GOP_size Ã— video_frame_duration<br/>
Valid when: GOP_duration is multiple of audio_packet_duration
            </div>

            <p><strong>Why this matters:</strong> Proper alignment ensures smooth playback without audio dropouts or sync drift in streaming applications.</p>
        </div>

         <!-- Segment Duration Analysis Section -->
        <div class="segment-analysis">
            <h3 style="margin-top: 0; color: #4a5568;">ðŸ“Š Segment Duration Analysis</h3>
            <div class="segment-input">
                <label for="segmentDurationInput" class="param-label">Target Segment Duration (seconds)</label>
                <input type="number" id="segmentDurationInput" value="6.0" step="0.1" min="0.1" max="60" onchange="analyzeSegmentDuration()">
                <button onclick="analyzeSegmentDuration()">Analyze Drift</button>
            </div>
            
            <div id="segmentResults" class="segment-results">
                <div style="text-align: center; padding: 20px; color: #a0aec0;">
                    Enter a segment duration and click "Analyze Drift"
                </div>
            </div>
        </div>
        <!-- END Segment Duration Analysis Section -->
    </div>

    <script>
        // Video and audio parameters
        let VIDEO_FPS = 30000 / 1001; // Default: Exact NTSC frame rate
        let AUDIO_SAMPLE_RATE = 48000; // Default sample rate
        let AUDIO_FRAMES_PER_PACKET = 1024; // Default frames per packet

        // Calculate derived values (will be recalculated when parameters change)
        let AUDIO_PACKET_DURATION = AUDIO_FRAMES_PER_PACKET / AUDIO_SAMPLE_RATE; // seconds
        let VIDEO_FRAME_DURATION = 1 / VIDEO_FPS; // seconds

        function updateAudioPacketDuration() {
            AUDIO_PACKET_DURATION = AUDIO_FRAMES_PER_PACKET / AUDIO_SAMPLE_RATE;
            document.getElementById('audioPacketDuration').textContent = 
                (AUDIO_PACKET_DURATION * 1000) + ' ms';
        }

        function evaluateFrameRate(frameRateStr) {
            // Handle fractional frame rates
            if (frameRateStr.includes('/')) {
                const [numerator, denominator] = frameRateStr.split('/');
                return parseFloat(numerator) / parseFloat(denominator);
            }
            return parseFloat(frameRateStr);
        }

        function onFrameRateChange() {
            const select = document.getElementById('frameRateSelect');
            const frameRateStr = select.value;
            
            // Update global frame rate
            VIDEO_FPS = evaluateFrameRate(frameRateStr);
            VIDEO_FRAME_DURATION = 1 / VIDEO_FPS;
            
            // Recalculate and display results
            calculateGOPSizes();
        }

        function onAudioParameterChange() {
            // Update audio parameters from select boxes
            AUDIO_SAMPLE_RATE = parseInt(document.getElementById('audioSampleRateSelect').value);
            AUDIO_FRAMES_PER_PACKET = parseInt(document.getElementById('audioFramesPerPacketSelect').value);
            
            // Recalculate audio packet duration and update display
            updateAudioPacketDuration();
            
            // Recalculate GOP sizes with new audio parameters
            calculateGOPSizes();
        }

        function analyzeSegmentDuration() {
            const targetDuration = parseFloat(document.getElementById('segmentDurationInput').value);
            
            if (isNaN(targetDuration) || targetDuration <= 0) {
                document.getElementById('segmentResults').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #e53e3e;">Please enter a valid segment duration</div>';
                return;
            }

            // Calculate valid audio and video segment durations
            const audioResults = calculateValidAudioSegment(targetDuration);
            const videoResults = calculateValidVideoSegment(targetDuration);
            
            // Calculate drift between audio and video
            const driftMs = Math.abs(audioResults.adjustedDuration - videoResults.adjustedDuration) * 1000;
            const driftPercent = (driftMs / (targetDuration * 1000)) * 100;
            
            displaySegmentAnalysis(targetDuration, audioResults, videoResults, driftMs, driftPercent);
        }

        function calculateValidAudioSegment(targetDuration) {
            // Find the closest number of audio packets that fits the target duration
            const targetPackets = targetDuration / AUDIO_PACKET_DURATION;
            const roundedPackets = Math.round(targetPackets);
            const adjustedDuration = roundedPackets * AUDIO_PACKET_DURATION;
            const driftMs = Math.abs(adjustedDuration - targetDuration) * 1000;
            
            return {
                targetPackets: targetPackets,
                actualPackets: roundedPackets,
                adjustedDuration: adjustedDuration,
                driftMs: driftMs
            };
        }

        function calculateValidVideoSegment(targetDuration) {
            // Find the closest number of frames that fits the target duration
            const targetFrames = targetDuration / VIDEO_FRAME_DURATION;
            const roundedFrames = Math.round(targetFrames);
            const adjustedDuration = roundedFrames * VIDEO_FRAME_DURATION;
            const driftMs = Math.abs(adjustedDuration - targetDuration) * 1000;
            
            return {
                targetFrames: targetFrames,
                actualFrames: roundedFrames,
                adjustedDuration: adjustedDuration,
                driftMs: driftMs
            };
        }

        function displaySegmentAnalysis(targetDuration, audioResults, videoResults, totalDriftMs, driftPercent) {
            const resultsDiv = document.getElementById('segmentResults');
            
            // Determine drift severity
            let driftClass = 'drift-good';
            let driftIcon = 'âœ…';
            let driftStatus = 'Excellent sync';
            
            if (totalDriftMs > 50) {
                driftClass = 'drift-warning';
                driftIcon = 'âš ï¸';
                driftStatus = 'Significant drift - may cause issues';
            } else if (totalDriftMs > 20) {
                driftClass = 'drift-card';
                driftIcon = 'âš¡';
                driftStatus = 'Minor drift - acceptable';
            }

            resultsDiv.innerHTML = `
                <div class="drift-card">
                    <div class="drift-title">ðŸŽ¯ Target Segment Duration</div>
                    <div class="drift-value" style="color: #4a5568;">${targetDuration.toFixed(3)} seconds</div>
                </div>

                <div class="drift-card">
                    <div class="drift-title">ðŸ”Š Audio Segment Analysis</div>
                    <div class="drift-value" style="color: #3182ce;">
                        ${audioResults.actualPackets} packets = ${audioResults.adjustedDuration}s
                    </div>
                    <div class="drift-details">
                        Target: ${audioResults.targetPackets} packets<br>
                        Adjustment: ${audioResults.driftMs}ms
                    </div>
                </div>

                <div class="drift-card">
                    <div class="drift-title">ðŸ“¹ Video Segment Analysis</div>
                    <div class="drift-value" style="color: #38a169;">
                        ${videoResults.actualFrames} frames = ${videoResults.adjustedDuration}s
                    </div>
                    <div class="drift-details">
                        Target: ${videoResults.targetFrames} frames<br>
                        Adjustment: ${videoResults.driftMs}ms
                    </div>
                </div>

                <div class="${driftClass}">
                    <div class="drift-title">${driftIcon} Audio/Video Drift Analysis</div>
                    <div class="drift-value" style="color: ${driftClass === 'drift-warning' ? '#e53e3e' : driftClass === 'drift-good' ? '#38a169' : '#4a5568'};">
                        ${totalDriftMs}ms drift (${driftPercent.toFixed(2)}%)
                    </div>
                    <div class="drift-details">
                        ${driftStatus}<br>
                        Audio duration: ${audioResults.adjustedDuration}s<br>
                        Video duration: ${videoResults.adjustedDuration}s
                    </div>
                </div>

                <div class="drift-card" style="background: #e6fffa;">
                    <div class="drift-title">ðŸ’¡ Recommendations</div>
                    <div class="drift-details">
                        ${totalDriftMs < 10 ? 
                            'Perfect! This segment duration works well for demuxed A/V streaming.' :
                            totalDriftMs < 25 ?
                            'Good choice. Minor drift is acceptable for most streaming scenarios.' :
                            totalDriftMs < 50 ?
                            'Consider adjusting segment duration to reduce drift for better sync.' :
                            'High drift detected. Consider using segment durations that align better with your frame rate and audio packet timing.'
                        }
                        <br><br>
                        <strong>Suggested alternatives:</strong><br>
                        Audio-aligned: ${audioResults.adjustedDuration}s<br>
                        Video-aligned: ${videoResults.adjustedDuration}s
                    </div>
                </div>
            `;
        }

        function gcd(a, b) {
            while (b !== 0) {
                let temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        function lcm(a, b) {
            return Math.abs(a * b) / gcd(a, b);
        }

        function isValidGOPSize(gopSize) {
            // GOP duration in seconds
            const gopDuration = gopSize * VIDEO_FRAME_DURATION;
            
            // Check if GOP duration is a multiple of audio packet duration
            // We use a small epsilon for floating point comparison
            const ratio = gopDuration / AUDIO_PACKET_DURATION;
            const roundedRatio = Math.round(ratio);
            const epsilon = 1e-10;
            
            return Math.abs(ratio - roundedRatio) < epsilon;
        }

        function calculateGOPSizes() {
            const validGOPSizes = [];
            let gopSize = 1;
            
            // Find first 20 valid GOP sizes
            while (validGOPSizes.length < 20) {
                if (isValidGOPSize(gopSize)) {
                    validGOPSizes.push(gopSize);
                }
                gopSize++;
                
                // Safety break to prevent infinite loops
                if (gopSize > 100000) {
                    break;
                }
            }
            
            displayResults(validGOPSizes);
        }

        function displayResults(gopSizes) {
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';
            
            gopSizes.forEach((gopSize, index) => {
                const gopDuration = (gopSize * VIDEO_FRAME_DURATION * 1000); // milliseconds
                
                const gopItem = document.createElement('div');
                gopItem.className = 'gop-item';
                gopItem.innerHTML = `
                    <div class="gop-number">${gopSize}</div>
                    <div class="gop-time">${gopDuration}ms</div>
                `;
                
                gopItem.addEventListener('click', () => {
                    showGOPDetails(gopSize);
                });
                
                resultsGrid.appendChild(gopItem);
            });
        }

        function showGOPDetails(gopSize) {
            const gopDurationMs = (gopSize * VIDEO_FRAME_DURATION * 1000);
            const gopDurationSec = gopSize * VIDEO_FRAME_DURATION;
            const audioPacketsPerGOP = Math.round(gopDurationSec / AUDIO_PACKET_DURATION);
            const selectedFrameRate = document.getElementById('frameRateSelect').value;
            const selectedSampleRate = document.getElementById('audioSampleRateSelect').value;
            const selectedFramesPerPacket = document.getElementById('audioFramesPerPacketSelect').value;
            
            alert(`GOP Size: ${gopSize} frames
Duration: ${gopDurationMs} ms (${gopDurationSec} seconds)
Audio packets per GOP: ${audioPacketsPerGOP}
Frame rate: ${selectedFrameRate} fps (${VIDEO_FPS})
Audio: ${selectedSampleRate} Hz, ${selectedFramesPerPacket} frames/packet
Perfect audio/video alignment: âœ“`);
        }

        // Initialize audio packet duration display and calculate on page load
        window.addEventListener('load', () => {
            updateAudioPacketDuration();
            setTimeout(() => {
                calculateGOPSizes();
                analyzeSegmentDuration(); // Also analyze default segment duration
            }, 500);
        });
    </script>
</body>
</html>
